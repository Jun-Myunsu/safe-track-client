import { MapContainer, TileLayer, Marker, Popup, useMap } from 'react-leaflet'
import { useEffect, useState, useMemo, useCallback } from 'react'
import L from 'leaflet'
import Compass from './components/Compass'
import DangerZoneOverlay from './components/DangerZoneOverlay'
import { analyzeDangerZones } from './services/dangerPredictionService'

// Í∏∞Î≥∏ ÎßàÏª§ ÏïÑÏù¥ÏΩò ÏÑ§Ï†ï
delete L.Icon.Default.prototype._getIconUrl
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
})

// ÎßàÏª§ ÏïÑÏù¥ÏΩò ÏÉùÏÑ± Ìï®Ïàò
const createUserMarkerIcon = () => L.divIcon({
  html: `
    <div style="position: relative; width: 24px; height: 24px;">
      <div style="background: linear-gradient(135deg, #ff6b6b, #ff3838); width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 3px 8px rgba(255, 59, 56, 0.4), 0 0 0 1px rgba(255, 59, 56, 0.2); display: flex; align-items: center; justify-content: center; position: relative; animation: pulse 2s infinite;">
        <span style="color: white; font-weight: bold; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">üìç</span>
      </div>
      <div style="position: absolute; top: -1px; right: -1px; background: #00ff88; width: 8px; height: 8px; border-radius: 50%; border: 1px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.2);"></div>
    </div>
    <style>@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }</style>
  `,
  className: 'current-user-marker',
  iconSize: [24, 24],
  iconAnchor: [12, 12]
})

const createOtherUserMarkerIcon = () => L.divIcon({
  html: `
    <div style="background: linear-gradient(135deg, #ff5722, #d32f2f); width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(255, 193, 7, 0.4), 0 0 0 1px rgba(255, 235, 59, 0.3); display: flex; align-items: center; justify-content: center; animation: blink 1.5s ease-in-out infinite;">
      <span style="font-size: 12px;">üö∂</span>
    </div>
    <style>@keyframes blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }</style>
  `,
  className: 'current-location-marker',
  iconSize: [20, 20],
  iconAnchor: [10, 10]
})

// ÏßÄÎèÑ Ï§ëÏã¨ ÏóÖÎç∞Ïù¥Ìä∏ Ïª¥Ìè¨ÎÑåÌä∏
function MapUpdater({ currentLocation, locations, currentUserId, setMapCenter, setMapBounds, setMapInstance }) {
  const map = useMap()
  
  useEffect(() => {
    if (setMapInstance) {
      setMapInstance(map)
    }
  }, [map, setMapInstance])
  
  useEffect(() => {
    const otherUserLocations = locations.filter(loc => loc.userId !== currentUserId)
    const bounds = map.getBounds()
    
    if (otherUserLocations.length > 0) {
      const latestLocation = otherUserLocations[otherUserLocations.length - 1]
      if (!bounds.contains([latestLocation.lat, latestLocation.lng])) {
        map.setView([latestLocation.lat, latestLocation.lng], map.getZoom())
        setMapCenter([latestLocation.lat, latestLocation.lng])
      }
    } else if (currentLocation && !bounds.contains([currentLocation.lat, currentLocation.lng])) {
      map.setView([currentLocation.lat, currentLocation.lng], map.getZoom())
      setMapCenter([currentLocation.lat, currentLocation.lng])
    }
  }, [currentLocation, locations, currentUserId, map, setMapCenter])
  
  useEffect(() => {
    const handleMoveEnd = () => {
      const center = map.getCenter()
      setMapCenter([center.lat, center.lng])
      setMapBounds(map.getBounds())
    }
    
    map.on('moveend', handleMoveEnd)
    setMapBounds(map.getBounds())
    
    return () => map.off('moveend', handleMoveEnd)
  }, [map, setMapCenter, setMapBounds])
  
  return null
}

function MapView({ locations, currentLocation, currentUserId, isTracking, myLocationHistory }) {
  // Í∏∞Î≥∏ Ï§ëÏã¨Ï†ê (Í¥ëÏ£º ÏãúÏ≤≠)
  const center = [35.1595, 126.8526]
  const [mapType, setMapType] = useState('street')
  const [showEmergency, setShowEmergency] = useState(false)
  const [showTraffic, setShowTraffic] = useState(true)
  const [mapCenter, setMapCenter] = useState(center)
  const [mapBounds, setMapBounds] = useState(null)
  const [emergencyLocations, setEmergencyLocations] = useState({ hospitals: [], police: [], stations: [] })
  const [showDangerZones, setShowDangerZones] = useState(false)
  const [dangerAnalysis, setDangerAnalysis] = useState(null)
  const [isAnalyzing, setIsAnalyzing] = useState(false)
  const [analysisError, setAnalysisError] = useState(null)
  const [showSafetyTips, setShowSafetyTips] = useState(false)
  const [mapInstance, setMapInstance] = useState(null)
  const [isMapRotating, setIsMapRotating] = useState(false)
  
  // Ïã§Ï†ú ÏùëÍ∏âÏãúÏÑ§ API Ìò∏Ï∂ú
  const fetchEmergencyFacilities = useCallback(async () => {
    if (!mapBounds || !showEmergency) return
    
    try {
      const bounds = mapBounds
      const south = bounds.getSouth()
      const west = bounds.getWest()
      const north = bounds.getNorth()
      const east = bounds.getEast()
      
      const query = `[out:json][timeout:25];(node["amenity"="hospital"](${south},${west},${north},${east});node["amenity"="police"](${south},${west},${north},${east});node["amenity"="fire_station"](${south},${west},${north},${east}););out geom;`
      
      const response = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        body: query
      })
      
      if (response.ok) {
        const data = await response.json()
        const hospitals = []
        const police = []
        const stations = []
        
        data.elements.forEach(element => {
          if (element.tags) {
            const facility = {
              name: element.tags.name || 'Ïù¥Î¶Ñ ÏóÜÏùå',
              lat: element.lat,
              lng: element.lon
            }
            
            if (element.tags.amenity === 'hospital') {
              hospitals.push(facility)
            } else if (element.tags.amenity === 'police') {
              police.push(facility)
            } else if (element.tags.amenity === 'fire_station') {
              stations.push(facility)
            }
          }
        })
        
        setEmergencyLocations({ hospitals, police, stations })
      }
    } catch (error) {
      console.error('ÏùëÍ∏âÏãúÏÑ§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error)
    }
  }, [mapBounds, showEmergency])
  
  useEffect(() => {
    fetchEmergencyFacilities()
  }, [fetchEmergencyFacilities])

  // AI ÏúÑÌóò ÏßÄÏó≠ Î∂ÑÏÑù
  const analyzeCurrentDanger = useCallback(async () => {
    if (!currentLocation || !isTracking || !showDangerZones) {
      return;
    }

    setIsAnalyzing(true);

    try {
      const result = await analyzeDangerZones({
        locationHistory: myLocationHistory || [],
        currentLocation,
        timestamp: new Date(),
        emergencyFacilities: emergencyLocations
      });

      if (result.success) {
        setDangerAnalysis(result.data);
        setAnalysisError(null);

        // ÏùåÏÑ± ÏïåÎ¶º (Ï†ÑÏ≤¥ ÏúÑÌóòÎèÑÍ∞Ä medium Ïù¥ÏÉÅÏùº Îïå)
        if (result.data.overallRiskLevel === 'high') {
          console.log('‚ö†Ô∏è ÎÜíÏùÄ ÏúÑÌóòÎèÑ Í∞êÏßÄ:', result.data);
        } else if (result.data.overallRiskLevel === 'medium') {
          console.log('‚ö° Ï§ëÍ∞Ñ ÏúÑÌóòÎèÑ Í∞êÏßÄ:', result.data);
        }
      } else {
        // API ÌÇ§ ÏóÜÍ±∞ÎÇò ÏóêÎü¨ Î∞úÏÉù ÏãúÏóêÎèÑ Í∏∞Î≥∏ Ï†ïÎ≥¥ ÌëúÏãú
        if (result.error === 'OpenAI API key not configured') {
          console.warn('üí° OpenAI API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Í∏∞Î≥∏ ÏïàÏ†Ñ Ï†ïÎ≥¥Î•º ÌëúÏãúÌï©ÎãàÎã§.');
          console.info('API ÌÇ§ ÏÑ§Ï†ï Î∞©Î≤ï: .env ÌååÏùºÏóê VITE_OPENAI_API_KEY=your_key Ï∂îÍ∞Ä');
          setAnalysisError('API ÌÇ§ ÏóÜÏùå (Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÇ¨Ïö©)');
        } else {
          console.warn('ÏúÑÌóò Î∂ÑÏÑù Ïã§Ìå®:', result.error);
          setAnalysisError(result.error);
        }
        setDangerAnalysis(result.data); // Í∏∞Î≥∏ ÏïàÏ†Ñ Ï†ïÎ≥¥ ÏÇ¨Ïö©
      }
    } catch (error) {
      console.error('ÏúÑÌóò Î∂ÑÏÑù Ïò§Î•ò:', error);
    } finally {
      setIsAnalyzing(false);
    }
  }, [currentLocation, isTracking, showDangerZones, myLocationHistory, emergencyLocations]);

  // ÏúÑÌóò ÏßÄÏó≠ ÌÜ†Í∏Ä ÏãúÏóêÎßå Ï¥àÍ∏∞ Î∂ÑÏÑù Ïã§Ìñâ (ÏúÑÏπò Î≥ÄÍ≤Ω Ïãú Ïû¨Ïã§Ìñâ Ïïà Ìï®)
  useEffect(() => {
    if (showDangerZones && isTracking && currentLocation) {
      analyzeCurrentDanger();
    }
  }, [showDangerZones]); // analyzeCurrentDanger ÏùòÏ°¥ÏÑ± Ï†úÍ±∞ÌïòÏó¨ ÏúÑÏπò Î≥ÄÍ≤Ω Ïãú Ïû¨Ïã§Ìñâ Î∞©ÏßÄ

  // ÏúÑÏπò Ï∂îÏ†Å Ï§ëÏßÄ Ïãú ÏúÑÌóòÎèÑ ÏòàÏ∏° Ï¥àÍ∏∞Ìôî
  useEffect(() => {
    const handleClearDangerAnalysis = () => {
      setDangerAnalysis(null)
      setShowDangerZones(false)
      setShowSafetyTips(false)
      setAnalysisError(null)
    }

    window.addEventListener('clearDangerAnalysis', handleClearDangerAnalysis)
    return () => window.removeEventListener('clearDangerAnalysis', handleClearDangerAnalysis)
  }, [])

  // 5Î∂ÑÎßàÎã§ ÏúÑÌóò Î∂ÑÏÑù ÏóÖÎç∞Ïù¥Ìä∏ (Ï∂îÏ†Å Ï§ëÏùº ÎïåÎßå)
  useEffect(() => {
    if (!showDangerZones || !isTracking) return;

    const interval = setInterval(() => {
      analyzeCurrentDanger();
    }, 300000); // 5Î∂Ñ(300Ï¥à)ÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏

    return () => clearInterval(interval);
  }, [showDangerZones, isTracking, analyzeCurrentDanger])
  
  const mapTypes = useMemo(() => ({
    street: {
      url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    },
    satellite: {
      url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    },
    detailed: {
      url: 'https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png',
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    },
    terrain: {
      url: 'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Tiles style by <a href="https://www.hotosm.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'
    }
  }), [])

  return (
    <div style={{ position: 'relative' }}>
      {/* ÎèôÏûëÌïòÎäî ÎÇòÏπ®Ìåê */}
      <div style={{
        position: 'absolute',
        bottom: '10px',
        left: '10px',
        zIndex: 999
      }}>
        <Compass />
      </div>
      
      {/* AI ÏúÑÌóò Î∂ÑÏÑù Î≤ÑÌäº (ÏßÄÎèÑ Î≤ÑÌäº ÏôºÏ™Ω) */}
      <div style={{
        position: 'absolute',
        top: '10px',
        right: '46px',
        zIndex: 1000,
        display: 'flex',
        flexDirection: 'column',
        gap: '6px'
      }}>
        <button
          className={`map-type-btn ${showDangerZones ? 'active' : ''}`}
          onClick={() => setShowDangerZones(!showDangerZones)}
          disabled={!isTracking}
          title={isTracking ? 'AI ÏúÑÌóò Î∂ÑÏÑù ÌÜ†Í∏Ä' : 'ÏúÑÏπò Ï∂îÏ†ÅÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî'}
        >
          ü§ñ
        </button>

        {/* ÏïàÏ†Ñ ÌåÅ ÏïåÎ¶º Î≤ÑÌäº */}
        {showDangerZones && dangerAnalysis && (
          <button
            className={`map-type-btn ${showSafetyTips ? 'active' : ''}`}
            onClick={() => setShowSafetyTips(!showSafetyTips)}
            title="ÏïàÏ†Ñ ÌåÅ Î≥¥Í∏∞"
            style={{
              backgroundColor: dangerAnalysis.overallRiskLevel === 'high' ? 'rgba(255, 51, 51, 0.9)' :
                             dangerAnalysis.overallRiskLevel === 'medium' ? 'rgba(255, 136, 0, 0.9)' : 'rgba(255, 100, 100, 0.85)'
            }}
          >
            üí°
          </button>
        )}
      </div>

      <div style={{
        position: 'absolute',
        top: '10px',
        right: '10px',
        zIndex: 1000,
        display: 'flex',
        flexDirection: 'column',
        gap: '6px'
      }}>
        <button
          className={`map-type-btn ${mapType === 'street' ? 'active' : ''}`}
          onClick={() => setMapType('street')}
        >
          üó∫Ô∏è
        </button>
        <button
          className={`map-type-btn ${mapType === 'satellite' ? 'active' : ''}`}
          onClick={() => setMapType('satellite')}
        >
          üõ∞Ô∏è
        </button>
        <button
          className={`map-type-btn ${mapType === 'detailed' ? 'active' : ''}`}
          onClick={() => setMapType('detailed')}
        >
          üè¢
        </button>
        <button
          className={`map-type-btn ${mapType === 'terrain' ? 'active' : ''}`}
          onClick={() => setMapType('terrain')}
        >
          ‚õ∞Ô∏è
        </button>
        <button
          className={`map-type-btn ${showEmergency ? 'active' : ''}`}
          onClick={() => setShowEmergency(!showEmergency)}
        >
          üö®
        </button>
        <button
          className={`map-type-btn ${showTraffic ? 'active' : ''}`}
          onClick={() => setShowTraffic(!showTraffic)}
        >
          üöó
        </button>
      </div>

      {/* ÏïàÏ†Ñ ÌåÅ ÌåùÏóÖ */}
      {showDangerZones && dangerAnalysis && showSafetyTips && (
        <div style={{
          position: 'absolute',
          top: '10px',
          right: '70px',
          zIndex: 10000,
          backgroundColor: 'rgba(42, 42, 42, 0.98)',
          padding: '16px',
          borderRadius: '8px',
          border: '2px solid ' + (dangerAnalysis.overallRiskLevel === 'high' ? '#ff3333' :
                                  dangerAnalysis.overallRiskLevel === 'medium' ? '#ff8800' : '#00ff88'),
          maxWidth: '320px',
          maxHeight: '400px',
          overflowY: 'auto',
          boxShadow: '0 6px 12px rgba(0,0,0,0.5)'
        }}>
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '12px'
          }}>
            <div style={{
              fontSize: '1.1rem',
              fontWeight: 'bold',
              color: dangerAnalysis.overallRiskLevel === 'high' ? '#ff3333' :
                     dangerAnalysis.overallRiskLevel === 'medium' ? '#ff8800' : '#00ff88'
            }}>
              {isAnalyzing ? 'üîÑ Î∂ÑÏÑù Ï§ë...' :
               dangerAnalysis.overallRiskLevel === 'high' ? '‚ö†Ô∏è ÎÜíÏùÄ Ï£ºÏùò ÌïÑÏöî' :
               dangerAnalysis.overallRiskLevel === 'medium' ? '‚ö° Ï£ºÏùò ÌïÑÏöî' : '‚úÖ ÏïàÏ†Ñ'}
            </div>
            <button
              onClick={() => setShowSafetyTips(false)}
              style={{
                background: 'transparent',
                border: 'none',
                color: '#aaa',
                fontSize: '1.2rem',
                cursor: 'pointer',
                padding: '0 4px'
              }}
            >
              ‚úï
            </button>
          </div>

          {analysisError && (
            <div style={{
              fontSize: '0.75rem',
              color: '#ffaa00',
              backgroundColor: 'rgba(255, 170, 0, 0.1)',
              padding: '6px 10px',
              borderRadius: '4px',
              marginBottom: '12px',
              border: '1px solid rgba(255, 170, 0, 0.3)'
            }}>
              üí° {analysisError}
            </div>
          )}

          <div style={{ fontSize: '0.9rem', color: '#cccccc' }}>
            <strong style={{ color: '#fff', fontSize: '1rem' }}>ÏïàÏ†Ñ ÌåÅ</strong>
            <ul style={{ margin: '8px 0', paddingLeft: '20px', listStyle: 'none' }}>
              {dangerAnalysis.safetyTips?.map((tip, idx) => (
                <li key={idx} style={{
                  marginBottom: '8px',
                  lineHeight: '1.5',
                  paddingLeft: '8px',
                  borderLeft: '3px solid ' + (dangerAnalysis.overallRiskLevel === 'high' ? '#ff3333' :
                                              dangerAnalysis.overallRiskLevel === 'medium' ? '#ff8800' : '#00ff88')
                }}>
                  ‚Ä¢ {tip}
                </li>
              ))}
            </ul>
          </div>

          {dangerAnalysis.dangerZones?.length > 0 && (
            <div style={{
              fontSize: '0.85rem',
              color: '#aaa',
              marginTop: '12px',
              paddingTop: '12px',
              borderTop: '1px solid #555'
            }}>
              üìç {dangerAnalysis.dangerZones.length}Í∞ú Ï£ºÏùò ÏßÄÏó≠Ïù¥ ÏßÄÎèÑÏóê ÌëúÏãúÎêòÏóàÏäµÎãàÎã§
            </div>
          )}
        </div>
      )}
      <MapContainer
        center={center}
        zoom={14}
        className="map-container"
      >
        <MapUpdater 
          currentLocation={currentLocation} 
          locations={locations} 
          currentUserId={currentUserId} 
          setMapCenter={setMapCenter} 
          setMapBounds={setMapBounds}
          setMapInstance={setMapInstance}
        />
        <TileLayer
          key={mapType}
          url={mapTypes[mapType].url}
          attribution={mapTypes[mapType].attribution}
        />
        
        {/* Ïã§ÏãúÍ∞Ñ ÍµêÌÜµÏÉÅÌô© Î†àÏù¥Ïñ¥ */}
        {showTraffic && (
          <TileLayer
            url="https://mt1.google.com/vt/lyrs=h@221097413,traffic&x={x}&y={y}&z={z}"
            attribution="Google Traffic"
            opacity={0.7}
          />
        )}
      
        {/* ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê ÏúÑÏπò */}
        {currentLocation && (
          <Marker 
            position={[currentLocation.lat, currentLocation.lng]}
            icon={createUserMarkerIcon()}
          >
            <Popup>
              <strong>ÎÇ¥ ÏúÑÏπò ({currentUserId})</strong><br/>
              ÏúÑÎèÑ: {currentLocation.lat.toFixed(6)}<br/>
              Í≤ΩÎèÑ: {currentLocation.lng.toFixed(6)}
            </Popup>
          </Marker>
        )}
        
        {/* Îã§Î•∏ ÏÇ¨Ïö©ÏûêÎì§Ïùò ÌòÑÏû¨ ÏúÑÏπòÎßå ÌëúÏãú */}
        {useMemo(() => {
          // Í∞Å ÏÇ¨Ïö©ÏûêÏùò ÏµúÏã† ÏúÑÏπòÎßå Ï∂îÏ∂ú
          const latestLocations = new Map()
          locations.forEach(location => {
            if (location.userId !== currentUserId) {
              latestLocations.set(location.userId, location)
            }
          })
          
          return Array.from(latestLocations.values()).map((location) => (
            <Marker 
              key={`current-${location.userId}`}
              position={[location.lat, location.lng]}
              icon={createOtherUserMarkerIcon()}
              zIndexOffset={1000}
            >
              <Popup>
                <strong>{location.userId} (ÌòÑÏû¨ ÏúÑÏπò)</strong><br/>
                ÏúÑÎèÑ: {location.lat.toFixed(6)}<br/>
                Í≤ΩÎèÑ: {location.lng.toFixed(6)}<br/>
                ÏãúÍ∞Ñ: {new Date(location.timestamp).toLocaleString()}
              </Popup>
            </Marker>
          ))
        }, [locations, currentUserId])}
        
        {/* ÏùëÍ∏âÏãúÏÑ§ ÎßàÏª§ */}
        {showEmergency && (
          <>
            {emergencyLocations.hospitals.map((hospital, index) => (
              <Marker
                key={`hospital-${hospital.lat}-${hospital.lng}`}
                position={[hospital.lat, hospital.lng]}
                icon={L.divIcon({
                  html: `<div style="background-color: #ff4444; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 8px;">üè•</div>`,
                  className: 'emergency-marker',
                  iconSize: [16, 16],
                  iconAnchor: [8, 8]
                })}
                zIndexOffset={500}
              >
                <Popup>
                  <strong>üè• {hospital.name}</strong><br/>
                  Î≥ëÏõê<br/>
                  ÏúÑÎèÑ: {hospital.lat.toFixed(6)}<br/>
                  Í≤ΩÎèÑ: {hospital.lng.toFixed(6)}
                </Popup>
              </Marker>
            ))}
            
            {emergencyLocations.police.map((station, index) => (
              <Marker
                key={`police-${station.lat}-${station.lng}`}
                position={[station.lat, station.lng]}
                icon={L.divIcon({
                  html: `<div style="background-color: #4444ff; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 8px;">üöî</div>`,
                  className: 'emergency-marker',
                  iconSize: [16, 16],
                  iconAnchor: [8, 8]
                })}
                zIndexOffset={500}
              >
                <Popup>
                  <strong>üöî {station.name}</strong><br/>
                  Í≤ΩÏ∞∞ÏÑú<br/>
                  ÏúÑÎèÑ: {station.lat.toFixed(6)}<br/>
                  Í≤ΩÎèÑ: {station.lng.toFixed(6)}
                </Popup>
              </Marker>
            ))}
            
            {emergencyLocations.stations.map((station, index) => (
              <Marker
                key={`station-${station.lat}-${station.lng}`}
                position={[station.lat, station.lng]}
                icon={L.divIcon({
                  html: `<div style="background-color: #00aa44; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 7px;">üõ°Ô∏è</div>`,
                  className: 'emergency-marker',
                  iconSize: [14, 14],
                  iconAnchor: [7, 7]
                })}
                zIndexOffset={400}
              >
                <Popup>
                  <strong>üõ°Ô∏è {station.name}</strong><br/>
                  ÌååÏ∂úÏÜå<br/>
                  ÏúÑÎèÑ: {station.lat.toFixed(6)}<br/>
                  Í≤ΩÎèÑ: {station.lng.toFixed(6)}
                </Popup>
              </Marker>
            ))}
          </>
        )}

        {/* AI ÏúÑÌóò ÏßÄÏó≠ Ïò§Î≤ÑÎ†àÏù¥ */}
        {showDangerZones && dangerAnalysis && (
          <DangerZoneOverlay dangerZones={dangerAnalysis.dangerZones} />
        )}
      </MapContainer>
    </div>
  )
}

export default MapView